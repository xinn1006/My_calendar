<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>AI 雲端智能排程器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-pop {
            animation: slideUp 0.4s ease-out forwards;
        }

        /* 讓按鈕在平板上更好按 */
        .dur-btn {
            transition: all 0.2s;
        }

        .dur-btn:active {
            transform: scale(0.95);
        }
    </style>
</head>

<body class="bg-slate-50 min-h-screen font-sans">

    <div class="max-w-lg mx-auto px-4 py-12">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-extrabold text-indigo-600 mb-2">Google 智能排程</h1>
            <div id="auth-status" class="text-xs font-bold uppercase tracking-widest text-slate-400">尚未連線至 Google</div>
        </div>

        <div class="bg-white rounded-3xl shadow-xl p-8 border border-indigo-50">
            <!-- Auth Button -->
            <div id="auth-section" class="mb-6">
                <button id="authorize_button" onclick="handleAuthClick()"
                    class="w-full py-4 bg-white border border-slate-200 rounded-2xl flex items-center justify-center space-x-2 hover:bg-slate-50 transition shadow-sm">
                    <img src="https://www.gstatic.com/images/branding/product/1x/gsa_512dp.png" class="w-6 h-6">
                    <span class="font-bold text-slate-700">連結 Google 日曆</span>
                </button>
                <button id="signout_button" onclick="handleSignoutClick()"
                    class="hidden w-full py-2 text-xs text-slate-400 underline mt-2 text-center">登出 Google 帳號</button>
            </div>

            <!-- Input Section -->
            <div id="setup-section" class="space-y-6 opacity-50 pointer-events-none transition-opacity duration-500">
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">行程名稱</label>
                    <input type="text" id="eventTitle" placeholder="例如：健身、深度工作"
                        class="w-full px-4 py-4 bg-slate-50 border border-slate-200 rounded-2xl outline-none focus:ring-2 focus:ring-indigo-500 text-lg">
                </div>

                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">預計時長</label>
                    <div class="grid grid-cols-4 gap-2">
                        <button onclick="setDuration(30, this)"
                            class="dur-btn py-3 border border-slate-200 rounded-xl text-sm font-medium bg-white">30m</button>
                        <button onclick="setDuration(60, this)"
                            class="dur-btn py-3 border-2 border-indigo-500 bg-indigo-50 rounded-xl text-sm font-bold text-indigo-700">1h</button>
                        <button onclick="setDuration(120, this)"
                            class="dur-btn py-3 border border-slate-200 rounded-xl text-sm font-medium bg-white">2h</button>
                        <button onclick="setDuration(180, this)"
                            class="dur-btn py-3 border border-slate-200 rounded-xl text-sm font-medium bg-white">3h</button>
                    </div>
                </div>

                <button onclick="findRealGaps()" id="scanBtn"
                    class="w-full bg-indigo-600 text-white font-bold py-5 rounded-2xl shadow-lg hover:bg-indigo-700 transition active:scale-95 text-lg">
                    分析 Google 日曆找空檔
                </button>
            </div>

            <!-- Loading -->
            <div id="loading-section" class="hidden py-16 text-center">
                <div
                    class="inline-block animate-spin rounded-full h-10 w-10 border-4 border-indigo-500 border-t-transparent">
                </div>
                <p class="text-slate-500 mt-4 font-medium italic">正在抓取雲端行程...</p>
            </div>

            <!-- Results Section -->
            <div id="confirm-section" class="hidden animate-pop space-y-6">
                <div class="flex items-center justify-between">
                    <h3 class="font-bold text-slate-800 text-lg flex items-center">
                        <i class="fa-solid fa-wand-magic-sparkles text-indigo-500 mr-2"></i>建議時段
                    </h3>
                    <button onclick="resetUI()"
                        class="text-sm text-indigo-600 font-bold hover:text-indigo-800 bg-indigo-50 px-4 py-2 rounded-full transition">
                        <i class="fa-solid fa-chevron-left mr-1"></i> 返回修改
                    </button>
                </div>

                <div id="slots-container" class="space-y-3">
                    <!-- 由 JS 動態生成 -->
                </div>

                <div class="flex flex-col space-y-3 pt-4 border-t border-slate-100">
                    <button id="confirm-sync-btn" onclick="syncToGoogle()"
                        class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-5 rounded-2xl shadow-lg shadow-green-100 transition-all flex items-center justify-center space-x-2 text-lg active:scale-95">
                        <i class="fa-solid fa-calendar-check"></i>
                        <span>確認並加入 Google 日曆</span>
                    </button>

                    <button onclick="shuffleSlots()"
                        class="w-full bg-slate-100 hover:bg-slate-200 text-slate-600 font-bold py-4 rounded-2xl transition-all flex items-center justify-center space-x-2 active:scale-95">
                        <i class="fa-solid fa-dice text-indigo-500"></i>
                        <span>不滿意？換一組隨機時段</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Google API Scripts -->
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>

    <script>
        /* --- 配置區 --- */
        const CLIENT_ID = '747855322166-jrkes0n86j1pv922po3v24qalqg61tgd.apps.googleusercontent.com';
        const SCOPES = 'https://www.googleapis.com/auth/calendar.events';
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest';

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let selectedDuration = 60;
        let selectedStartTime = null;
        let cachedEvents = []; // 暫存已抓取的行程，加速隨機生成

        /* --- Google API 初始化 --- */
        function gapiLoaded() { gapi.load('client', intializeGapiClient); }
        async function intializeGapiClient() {
            await gapi.client.init({ discoveryDocs: [DISCOVERY_DOC] });
            gapiInited = true;
            checkAuthStatus();
        }
        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                ux_mode: 'popup', // 明確指定使用彈出視窗模式
                callback: '',
            });
            gisInited = true;
            checkAuthStatus();
        }

        function checkAuthStatus() {
            if (gapiInited && gisInited) {
                const token = localStorage.getItem('google_token');
                if (token) {
                    gapi.client.setToken({ access_token: token });
                    onAuthSuccess();
                }
            }
        }

        function handleAuthClick() {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) throw (resp);
                localStorage.setItem('google_token', resp.access_token);
                onAuthSuccess();
            };
            tokenClient.requestAccessToken({ prompt: 'consent' });
        }

        function onAuthSuccess() {
            document.getElementById('setup-section').classList.remove('opacity-50', 'pointer-events-none');
            document.getElementById('authorize_button').classList.add('hidden');
            document.getElementById('signout_button').classList.remove('hidden');
            document.getElementById('auth-status').innerText = "Google 已連線";
            document.getElementById('auth-status').classList.replace('text-slate-400', 'text-green-500');
        }

        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
                localStorage.removeItem('google_token');
                location.reload();
            }
        }

        /* --- 排程核心邏輯 --- */
        async function findRealGaps() {
            const title = document.getElementById('eventTitle').value.trim();
            if (!title) { alert('請輸入行程名稱'); return; }

            document.getElementById('setup-section').classList.add('hidden');
            document.getElementById('loading-section').classList.remove('hidden');

            try {
                const now = new Date();
                const endLimit = new Date(now.getTime() + 72 * 60 * 60 * 1000); // 抓 3 天

                const response = await gapi.client.calendar.events.list({
                    'calendarId': 'primary',
                    'timeMin': now.toISOString(),
                    'timeMax': endLimit.toISOString(),
                    'showDeleted': false,
                    'singleEvents': true,
                    'orderBy': 'startTime',
                });

                cachedEvents = response.result.items;
                const gaps = calculateGaps(cachedEvents, selectedDuration);
                displayGaps(gaps);

            } catch (err) {
                console.error(err);
                alert('連線逾時或失敗，請重新登入');
                handleSignoutClick();
            }
        }

        function calculateGaps(events, durationMin) {
            let suggestions = [];
            let searchPtr = new Date();
            searchPtr.setMinutes(Math.ceil(searchPtr.getMinutes() / 15) * 15, 0, 0);

            while (suggestions.length < 3) {
                if (searchPtr.getHours() >= 22 || searchPtr.getHours() < 8) {
                    searchPtr.setDate(searchPtr.getDate() + 1);
                    searchPtr.setHours(9, 0, 0);
                    continue;
                }

                let slotEnd = new Date(searchPtr.getTime() + durationMin * 60000);
                let isOverlap = events.some(event => {
                    let start = new Date(event.start.dateTime || event.start.date);
                    let end = new Date(event.end.dateTime || event.end.date);
                    return (searchPtr < end && slotEnd > start);
                });

                if (!isOverlap) {
                    suggestions.push(new Date(searchPtr));
                    searchPtr.setHours(searchPtr.getHours() + 4);
                } else {
                    searchPtr.setMinutes(searchPtr.getMinutes() + 30);
                }
            }
            return suggestions;
        }

        // 隨機生成功能
        function shuffleSlots() {
            const container = document.getElementById('slots-container');
            container.innerHTML = '<div class="text-center py-8"><i class="fa-solid fa-dice fa-spin text-3xl text-indigo-300"></i><p class="text-slate-400 mt-2">尋找隨機時段...</p></div>';

            setTimeout(() => {
                let randomSuggestions = [];
                let attempts = 0;
                while (randomSuggestions.length < 3 && attempts < 50) {
                    attempts++;
                    let randomDay = Math.floor(Math.random() * 3);
                    let randomHour = Math.floor(Math.random() * 12) + 9; // 9:00 - 21:00
                    let testDate = new Date();
                    testDate.setDate(testDate.getDate() + randomDay);
                    testDate.setHours(randomHour, Math.random() > 0.5 ? 30 : 0, 0, 0);

                    let slotEnd = new Date(testDate.getTime() + selectedDuration * 60000);
                    let isOverlap = cachedEvents.some(event => {
                        let start = new Date(event.start.dateTime || event.start.date);
                        let end = new Date(event.end.dateTime || event.end.date);
                        return (testDate < end && slotEnd > start);
                    });

                    if (!isOverlap && testDate > new Date()) {
                        randomSuggestions.push(testDate);
                    }
                }
                displayGaps(randomSuggestions);
            }, 600);
        }

        function displayGaps(gaps) {
            document.getElementById('loading-section').classList.add('hidden');
            document.getElementById('confirm-section').classList.remove('hidden');
            const container = document.getElementById('slots-container');
            container.innerHTML = '';

            if (gaps.length === 0) {
                container.innerHTML = '<p class="text-center text-red-400">找不到合適空檔，請嘗試縮短時長。</p>';
                return;
            }

            gaps.forEach((time, i) => {
                const endTime = new Date(time.getTime() + selectedDuration * 60000);
                const div = document.createElement('div');
                div.className = `p-5 border-2 rounded-2xl cursor-pointer transition-all flex justify-between items-center ${i === 0 ? 'border-indigo-600 bg-indigo-50 shadow-md' : 'border-slate-100 bg-slate-50'}`;
                div.onclick = () => {
                    selectedStartTime = time;
                    Array.from(container.children).forEach(c => {
                        c.className = 'p-5 border-2 border-slate-100 bg-slate-50 rounded-2xl cursor-pointer transition-all flex justify-between items-center';
                    });
                    div.className = 'p-5 border-2 border-indigo-600 bg-indigo-50 rounded-2xl cursor-pointer transition-all flex justify-between items-center shadow-md';
                };
                div.innerHTML = `
                    <div>
                        <p class="text-sm font-bold text-indigo-500 mb-1">${time.toLocaleDateString('zh-TW', { weekday: 'long', month: 'short', day: 'numeric' })}</p>
                        <p class="text-xl font-black text-slate-800">${formatTime(time)} - ${formatTime(endTime)}</p>
                    </div>
                    <i class="fa-solid fa-circle-check ${i === 0 ? 'text-indigo-600' : 'text-slate-200'} text-2xl"></i>
                `;
                container.appendChild(div);
            });
            selectedStartTime = gaps[0];
        }

        function formatTime(date) {
            return date.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', hour12: false });
        }

        async function syncToGoogle() {
            const title = document.getElementById('eventTitle').value;
            const btn = document.getElementById('confirm-sync-btn');
            const endTime = new Date(selectedStartTime.getTime() + selectedDuration * 60000);

            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> <span>正在寫入日曆...</span>';

            const event = {
                'summary': title,
                'description': '透過 AI 智能排程器自動建立',
                'start': { 'dateTime': selectedStartTime.toISOString() },
                'end': { 'dateTime': endTime.toISOString() }
            };

            try {
                await gapi.client.calendar.events.insert({ 'calendarId': 'primary', 'resource': event });
                btn.className = btn.className.replace('bg-green-500', 'bg-blue-500');
                btn.innerHTML = '<i class="fa-solid fa-check"></i> <span>已成功加入！</span>';

                setTimeout(() => {
                    if (confirm('成功！是否前往 Google 日曆查看？')) {
                        window.location.href = "https://calendar.google.com/";
                    } else {
                        location.reload();
                    }
                }, 800);
            } catch (err) {
                alert('同步失敗：' + err.result.error.message);
                btn.disabled = false;
            }
        }

        function resetUI() {
            document.getElementById('confirm-section').classList.add('hidden');
            document.getElementById('setup-section').classList.remove('hidden');
        }

        function setDuration(min, el) {
            selectedDuration = min;
            document.querySelectorAll('.dur-btn').forEach(b => {
                b.className = "dur-btn py-3 border border-slate-200 rounded-xl text-sm font-medium bg-white";
            });
            el.className = "dur-btn py-3 border-2 border-indigo-500 bg-indigo-50 rounded-xl text-sm font-bold text-indigo-700";
        }
    </script>
</body>

</html>
